# About

This package provisions a node to be part of a [StarRocks](https://www.starrocks.io/) cluster.

# Usage

## Input

The module takes the following variables as input:

- **name**: Name to give to the vm. Will be the hostname by default as well.

- **hostname**: Used to give the vm an internal hostname that is different from the vm's name. It takes the following fields:
  - **hostname**: Hostname to give to the vm.
  - **is_fqdn**: Boolean indicating whether the hostname is a fully qualified domain name or not.

- **vcpus**: Number of vcpus to assign to the vm. Defaults to **1**.

- **memory**: Amount of memory to assign to the vm in MiB. Defaults to **512**.

- **volume_id**: Id of the disk volume to attach to the vm.

- **libvirt_networks**: Parameters to connect to libvirt networks. Each entry has the following keys:
  - **network_name**: Name of the libvirt network to connect to (in which case **network_id** should be an empty string).
  - **network_id**: Id (ie, uuid) of the libvirt network to connect to (in which case **network_name** should be an empty string).
  - **ip**: Ip of interface connecting to the libvirt network.
  - **mac**: Mac address of interface connecting to the libvirt network.
  - **gateway**: Ip of the network's gateway. Usually the gateway the first assignable address of a libvirt's network.
  - **dns_servers**: Dns servers to use. Usually the dns server is first assignable address of a libvirt's network.

- **macvtap_interfaces**: List of macvtap interfaces to connect the vm to if you opt for macvtap interfaces. Each entry in the list is a map with the following keys:
  - **interface**: Host network interface that you plan to connect your macvtap interface with.
  - **prefix_length**: Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** for example, this would be 24.
  - **ip**: Ip associated with the macvtap interface. 
  - **mac**: Mac address associated with the macvtap interface
  - **gateway**: Ip of the network's gateway for the network the interface will be connected to.
  - **dns_servers**: Dns servers for the network the interface will be connected to. If there aren't dns servers setup for the network your vm will connect to, the ip of external dns servers accessible from the network will work as well.

- **cloud_init_volume_pool**: Name of the volume pool that will contain the cloud-init volume of the vm.

- **cloud_init_volume_name**: Name of the cloud-init volume that will be generated by the module for your vm. If left empty, it will default to ``<vm name>-cloud-init.iso``.

- **ssh_admin_user**: Username of the default sudo user in the image. Defaults to **ubuntu**.

- **admin_user_password**: Optional password for the default sudo user of the image. Note that this will not enable ssh password connections, but it will allow you to log into the vm from the host using the **virsh console** command.

- **ssh_admin_public_key**: Public part of the ssh key that will be used to login as the admin on the vm.

- **chrony**: Optional chrony configuration for when you need a more fine-grained ntp setup on your vm. It is an object with the following fields:
  - **enabled**: If set to false (the default), chrony will not be installed and the vm ntp settings will be left to default.
  - **servers**: List of ntp servers to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#server)
  - **pools**: A list of ntp server pools to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#pool)
  - **makestep**: An object containing remedial instructions if the clock of the vm is significantly out of sync at startup. It is an object containing two properties, **threshold** and **limit** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#makestep)

- **fluentbit**: Optional fluent-bit configuration to securely route logs to a fluentd/fluent-bit node using the forward plugin. Alternatively, configuration can be 100% dynamic by specifying the parameters of an etcd store to fetch the configuration from. It has the following keys:
  - **enabled**: If set to false (the default), fluent-bit will not be installed.
  - **starrocks_systemd_service_tag**: Tag to assign to logs coming from StarRocks systemd service
  - **node_exporter_systemd_service_tag** Tag to assign to logs coming from Prometheus Node Exporter systemd service
  - **starrocks_log_file_tag** Tag to assign to logs coming from StarRocks log file (`fe.log` for a FE node, otherwise *`node_type`*`.INFO`)
  - **metrics**: Configuration for metrics fluentbit exposes. It has the following keys:
    - **enabled**: Whether to enable the metrics or not
    - **port**: Port to expose the metrics on
  - **forward**: Configuration for the forward plugin that will talk to the external fluentd/fluent-bit node. It has the following keys:
    - **domain**: Ip or domain name of the remote fluentd node.
    - **port**: Port the remote fluentd node listens on
    - **hostname**: Unique hostname identifier for the vm
    - **shared_key**: Secret shared key with the remote fluentd node to authentify the client
    - **ca_cert**: CA certificate that signed the remote fluentd node's server certificate (used to authentify it)

- **fluentbit_dynamic_config**: Optional configuration to update fluent-bit configuration dynamically either from an etcd key prefix or a path in a git repo.
  - **enabled**: Boolean flag to indicate whether dynamic configuration is enabled at all. If set to true, configurations will be set dynamically. The default configurations can still be referenced as needed by the dynamic configuration. They are at the following paths:
    - **Global Service Configs**: /etc/fluent-bit-customization/default-config/service.conf
    - **Default Variables**: /etc/fluent-bit-customization/default-config/default-variables.conf
    - **Systemd Inputs**: /etc/fluent-bit-customization/default-config/inputs.conf
    - **Forward Output For All Inputs**: /etc/fluent-bit-customization/default-config/output-all.conf
    - **Forward Output For Default Inputs Only**: /etc/fluent-bit-customization/default-config/output-default-sources.conf
  - **source**: Indicates the source of the dynamic config. Can be either **etcd** or **git**.
  - **etcd**: Parameters to fetch fluent-bit configurations dynamically from an etcd cluster. It has the following keys:
    - **key_prefix**: Etcd key prefix to search for fluent-bit configuration
    - **endpoints**: Endpoints of the etcd cluster. Endpoints should have the format `<ip>:<port>`
    - **ca_certificate**: CA certificate against which the server certificates of the etcd cluster will be verified for authenticity
    - **client**: Client authentication. It takes the following keys:
      - **certificate**: Client tls certificate to authentify with. To be used for certificate authentication.
      - **key**: Client private tls key to authentify with. To be used for certificate authentication.
      - **username**: Client's username. To be used for username/password authentication.
      - **password**: Client's password. To be used for username/password authentication.
  - **git**: Parameters to fetch fluent-bit configurations dynamically from an git repo. It has the following keys:
    - **repo**: Url of the git repository. It should have the ssh format.
    - **ref**: Git reference (usually branch) to checkout in the repository
    - **path**: Path to sync from in the git repository. If the empty string is passed, syncing will happen from the root of the repository.
    - **trusted_gpg_keys**: List of trusted gpp keys to verify the signature of the top commit. If an empty list is passed, the commit signature will not be verified.
    - **auth**: Authentication to the git server. It should have the following keys:
      - **client_ssh_key** Private client ssh key to authentication to the server.
      - **server_ssh_fingerprint**: Public ssh fingerprint of the server that will be used to authentify it.

- **install_dependencies**: Whether cloud-init should install external dependencies (should be set to false if you already provide an image with the external dependencies built-in). Defaults to **true**.

- **timezone**: Timezone to set on each node. Defaults to **America/Montreal**.

- **starrocks**: StarRocks configuration. It has the following keys:
  - **release_version**: StarRocks release version to install.
  - **node_type**: StarRocks node type to configure, either **fe** or **be**.
  - **fe_config**: StarRocks FE-related settings (**initial_leader** + **initial_follower** + **ssl** + **iceberg_rest**). Only needed if **node_type** is set to **fe**.
